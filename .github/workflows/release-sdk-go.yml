# Release Go SDK
#
# WORKFLOW PURPOSE:
# This workflow handles the Go SDK release process when a new version tag is pushed.
# It creates GitHub releases and updates the SDK version in the template configuration.
#
# FLOW:
# 1. Tag validation and version parsing
# 2. Run tests with build tags to exclude Spin SDK  
# 3. Create GitHub release with dual tagging strategy:
#    - sdk-go-v{version} (release tracking)
#    - sdk/go/v{version} (Go module resolution)
# 4. Create template version update PR
#
# FAILURE HANDLING:
# - Manual workflow dispatch available for retries
# - Template validation handled separately to avoid proxy timing issues
#
name: Release Go SDK

on:
  push:
    tags:
      - 'sdk-go-v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Go SDK tag to release (e.g., sdk-go-v1.2.3)'
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  verify-tag:
    name: Verify Tag on Main Branch
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.parse.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Parse tag
        id: parse
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TAG="${{ inputs.tag }}"
            if [[ ! "$TAG" =~ ^sdk-go-v ]]; then
              echo "ERROR: Manual tag must start with 'sdk-go-v'"
              exit 1
            fi
            VERSION="${TAG#sdk-go-v}"
          else
            VERSION="${GITHUB_REF#refs/tags/sdk-go-v}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"
          echo "Trigger: ${{ github.event_name }}"
      
      - name: Verify tag is on main branch
        uses: ./.github/actions/verify-tag
      
      - name: Verify version matches README
        working-directory: sdk/go
        run: |
          VERSION="${{ steps.parse.outputs.version }}"
          README_VERSION=$(grep "^Version: " README.md | cut -d' ' -f2)
          if [ "$README_VERSION" != "$VERSION" ]; then
            echo "ERROR: Tag version ($VERSION) does not match README.md version ($README_VERSION)"
            exit 1
          fi
          echo "SUCCESS: Version matches README.md"

  validate-and-test:
    name: Validate and Test
    needs: verify-tag
    runs-on: ubuntu-latest
    outputs:
      current_version: ${{ steps.get_version.outputs.current_version }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Validate version format
      run: |
        if ! [[ "${{ needs.verify-tag.outputs.version }}" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9]+)?$ ]]; then
          echo "ERROR: Invalid version format. Please use semantic versioning (e.g., 1.0.0 or 1.0.0-beta1)"
          exit 1
        fi

    - name: Get current version
      id: get_version
      working-directory: sdk/go
      run: |
        # For Go modules, we'll check the latest git tag for this SDK
        current_version=$(git tag -l "sdk-go-v*" --sort=-version:refname | head -n 1 | sed 's|sdk-go-v||')
        if [ -z "$current_version" ]; then
          echo "No existing Go SDK tags found, assuming this is the first release"
          current_version="0.1.0"
        fi
        echo "current_version=$current_version" >> $GITHUB_OUTPUT
        echo "Current version: $current_version"
        echo "New version: ${{ needs.verify-tag.outputs.version }}"

    - name: Check version is newer
      run: |
        current="${{ steps.get_version.outputs.current_version }}"
        new="${{ needs.verify-tag.outputs.version }}"
        
        # Skip version comparison if this is the first release
        if [ "$current" = "0.1.0" ] && [ -z "$(git tag -l 'sdk-go-v*')" ]; then
          echo "SUCCESS: First release - no version comparison needed"
        else
          # Simple version comparison (works for most cases)
          if [ "$(printf '%s\n' "$new" "$current" | sort -V | tail -n1)" != "$new" ]; then
            echo "ERROR: New version ($new) must be higher than current version ($current)"
            exit 1
          fi
          echo "SUCCESS: Version $new is newer than $current"
        fi

  release:
    name: Create Release
    needs: [verify-tag, validate-and-test]
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Git
      uses: ./.github/actions/setup-git
      with:
        token: ${{ secrets.PAT || github.token }}

    - name: Create Go module subdirectory tag
      run: |
        # Create Go module subdirectory tag for proper Go module versioning
        go_module_tag="sdk/go/v${{ needs.verify-tag.outputs.version }}"
        if git tag -l "$go_module_tag" | grep -q "$go_module_tag"; then
          echo "Tag $go_module_tag already exists, skipping creation"
        else
          git tag -a "$go_module_tag" -m "Release Go SDK v${{ needs.verify-tag.outputs.version }}"
          git push origin "$go_module_tag"
          echo "Created and pushed tag $go_module_tag"
        fi

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ github.event_name == 'workflow_dispatch' && inputs.tag || github.ref_name }}
        name: "Go SDK v${{ needs.verify-tag.outputs.version }}"
        draft: false
        prerelease: false
        generate_release_notes: true
        body: |
          ## Go SDK v${{ needs.verify-tag.outputs.version }}
          
          ### Installation
          
          ```bash
          go get github.com/fastertools/ftl-cli/sdk/go@v${{ needs.verify-tag.outputs.version }}
          ```
          
          ### Links
          
          - [Go Packages](https://pkg.go.dev/github.com/fastertools/ftl-cli/sdk/go@v${{ needs.verify-tag.outputs.version }})
          - [Documentation](https://github.com/fastertools/ftl-cli/tree/main/sdk/go)

    - name: Report module information
      run: |
        echo ""
        echo "Go module users can import with:"
        echo "  go get github.com/fastertools/ftl-cli/sdk/go@v${{ needs.verify-tag.outputs.version }}"
        echo ""
        echo "Created tags:"
        echo "  - sdk-go-v${{ needs.verify-tag.outputs.version }} (release tracking)"
        echo "  - sdk/go/v${{ needs.verify-tag.outputs.version }} (Go module resolution)"
        echo ""
        echo "WARNING: Module may take a few minutes to appear in the Go module proxy"

  update-templates:
    name: Update Templates PR
    needs: [verify-tag, release]
    if: needs.release.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT || github.token }}
      
      - name: Setup Git
        uses: ./.github/actions/setup-git
        with:
          token: ${{ secrets.PAT || github.token }}
      
      - name: Create update branch
        run: |
          BRANCH="update-templates-sdk-go-v${{ needs.verify-tag.outputs.version }}"
          git checkout -b "$BRANCH"
          echo "UPDATE_BRANCH=$BRANCH" >> $GITHUB_ENV
      
      - name: Update template versions
        run: |
          VERSION="${{ needs.verify-tag.outputs.version }}"
          
          # Update Go SDK version in versions.json
          jq --arg v "$VERSION" '.go = $v' internal/scaffold/versions.json > versions.tmp
          mv versions.tmp internal/scaffold/versions.json
          
          echo "âœ… Updated Go SDK to v$VERSION in versions.json"
      
      - name: Commit changes
        run: |
          git add -A
          if git diff --staged --quiet; then
            echo "No template updates needed"
            exit 0
          fi
          git commit -m "chore: update templates to use Go SDK v${{ needs.verify-tag.outputs.version }}" \
            -m "Updates project templates to use the newly published SDK version." \
            -m "This is an automated update following the release of Go SDK v${{ needs.verify-tag.outputs.version }}."
      
      - name: Push update branch
        run: |
          git push origin "$UPDATE_BRANCH"
      
      - name: Create Pull Request
        env:
          GH_TOKEN: ${{ secrets.PAT || github.token }}
        run: |
          VERSION="${{ needs.verify-tag.outputs.version }}"
          
          PR_BODY=$(cat <<EOF
          ## Update Templates to Go SDK v${VERSION}
          
          This PR updates project templates to use the newly published Go SDK version.
          
          ### Changes
          - Updated Go SDK version to v${VERSION} in internal/scaffold/versions.json
          - This will affect all new Go components created with \`ftl component add\`
          
          ### Context
          This is an automated PR created after successfully publishing Go SDK v${VERSION}.
          
          ### Checklist
          - [x] SDK v${VERSION} tag has been created
          - [x] Go module subdirectory tag created for proper versioning
          - [x] Templates updated to new version
          - [ ] CI tests pass with new version
          
          ### Links
          - [Go Packages](https://pkg.go.dev/github.com/fastertools/ftl-cli/sdk/go@v${VERSION})
          - [Release](https://github.com/fastertools/ftl-cli/releases/tag/sdk-go-v${VERSION})
          
          ---
          *This PR was automatically created by the release workflow*
          EOF
          )
          
          gh pr create \
            --title "chore: update templates to Go SDK v${VERSION}" \
            --body "$PR_BODY" \
            --base main \
            --head "$UPDATE_BRANCH" \
            --label "automated" \
            --label "dependencies"