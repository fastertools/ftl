name: CLI Tests

on:
  push:
    branches: [ main ]
    paths:
      - 'src/**'
      - 'Cargo.toml'
      - 'Cargo.lock'
      - 'Makefile'\n      - '.github/workflows/test-cli.yml'
      - 'templates/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'src/**'
      - 'Cargo.toml'
      - 'Cargo.lock'
      - 'Makefile'\n      - '.github/workflows/test-cli.yml'
      - 'templates/**'

jobs:
  test-rust-e2e:
    name: CLI Test - Rust
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libdbus-1-dev
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-wasip1
      
      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Install cargo-binstall
        uses: cargo-bins/cargo-binstall@main
      
      - name: Install ftl CLI
        run: |
          cargo install --path .
      
      - name: Setup Spin
        uses: fermyon/actions/spin/setup@v1
        with:
          version: v3.3.1
      
      - name: Install Spin templates
        run: |
          spin templates install --git https://github.com/fermyon/spin --upgrade
      
      - name: Setup ftl templates
        run: |
          ftl setup templates --force
      
      - name: Test Rust workflow
        run: |
          # Create a test project
          WORK_DIR=$(mktemp -d)
          cd $WORK_DIR
          ftl init test-project
          cd test-project
          
          # Add a Rust tool
          ftl add test-rust --language rust --description "Test Rust tool"
          
          # Verify tool_components was updated
          grep -q "test-rust" spin.toml || (echo "tool_components not updated" && exit 1)
          
          # Build the project
          ftl build
          
          # Test that ftl up works (just verify it starts)
          timeout 5s ftl up || true

  test-multi-tool:
    name: CLI Test - Multiple Tools
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libdbus-1-dev
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-wasip1
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Install ftl CLI
        run: |
          cargo install --path .
      
      - name: Setup Spin
        uses: fermyon/actions/spin/setup@v1
        with:
          version: v3.3.1
      
      - name: Install Spin templates
        run: |
          spin templates install --git https://github.com/fermyon/spin --upgrade
      
      - name: Setup ftl templates
        run: |
          ftl setup templates --force
      
      - name: Test multiple tools workflow
        run: |
          # Create a test project
          WORK_DIR=$(mktemp -d)
          cd $WORK_DIR
          ftl init test-project
          cd test-project
          
          # Add multiple tools
          ftl add rust-tool --language rust --description "Rust tool"
          ftl add ts-tool --language typescript --description "TypeScript tool"
          
          # Verify both tools are in tool_components
          grep -q "rust-tool" spin.toml || (echo "rust-tool not in tool_components" && exit 1)
          grep -q "ts-tool" spin.toml || (echo "ts-tool not in tool_components" && exit 1)
          
          # Build the project
          ftl build

  test-typescript-e2e:
    name: CLI Test - TypeScript
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libdbus-1-dev
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Cache cargo index
        uses: actions/cache@v4
        with:
          path: ~/.cargo/git
          key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Install ftl CLI
        run: |
          cargo install --path .
      
      - name: Setup Spin
        uses: fermyon/actions/spin/setup@v1
        with:
          version: v3.3.1
      
      - name: Install Spin templates
        run: |
          spin templates install --git https://github.com/fermyon/spin --upgrade
      
      - name: Setup ftl templates
        run: |
          ftl setup templates --force
      
      - name: Test TypeScript workflow
        run: |
          # Create a test project
          WORK_DIR=$(mktemp -d)
          cd $WORK_DIR
          ftl init test-project
          cd test-project
          
          # Add a TypeScript tool
          ftl add test-ts --language typescript --description "Test TypeScript tool"
          
          # Verify tool_components was updated
          grep -q "test-ts" spin.toml || (echo "tool_components not updated" && exit 1)
          
          # Build the project
          ftl build