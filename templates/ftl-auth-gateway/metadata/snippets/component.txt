# IMPORTANT: This snippet modifies the existing MCP gateway configuration
# The auth gateway will handle /mcp and forward to the internal MCP gateway

# First, update the existing mcp component trigger to use a private route:
# Change:
#   [[trigger.http]]
#   route = "/mcp"
#   component = "mcp"
# To:
#   [[trigger.http]]
#   route = { private = true }
#   component = "ftl-mcp-gateway"

# MCP Authorizer Configuration
[variables]
# Core MCP settings
mcp_gateway_url = { default = "http://ftl-mcp-gateway.spin.internal" }
mcp_trace_header = { default = "X-Trace-Id" }

# JWT Provider configuration
mcp_provider_type = { default = "jwt" }  # "jwt" or "static"
mcp_jwt_issuer = { default = "" }
mcp_jwt_audience = { default = "" }
mcp_jwt_jwks_uri = { default = "" }
mcp_jwt_public_key = { default = "" }
mcp_jwt_algorithm = { default = "RS256" }
mcp_jwt_required_scopes = { default = "" }

# OAuth endpoints (optional)
mcp_oauth_authorize_endpoint = { default = "" }
mcp_oauth_token_endpoint = { default = "" }
mcp_oauth_userinfo_endpoint = { default = "" }

# Ownership validation (set by platform for FTL-managed auth)
mcp_user_id = { default = "" }  # For user-owned apps
mcp_org_id = { default = "" }   # For org-owned apps

# Static token provider (for development)
mcp_static_tokens = { default = "" }

# Auth Gateway - handles authentication and OAuth discovery
[[trigger.http]]
route = "/mcp"
component = "mcp"

[[trigger.http]]
route = "/.well-known/oauth-protected-resource"
component = "mcp"

[[trigger.http]]
route = "/.well-known/oauth-authorization-server"
component = "mcp"

[component.mcp]
source = { registry = "ghcr.io", package = "fastertools:ftl-mcp-authorizer", version = "0.0.14" }
allowed_outbound_hosts = ["http://*.spin.internal", "https://*.authkit.app", "https://*.workos.com"]
[component.mcp.variables]
mcp_gateway_url = "{% raw %}{{ mcp_gateway_url }}{% endraw %}"
mcp_trace_header = "{% raw %}{{ mcp_trace_header }}{% endraw %}"
mcp_provider_type = "{% raw %}{{ mcp_provider_type }}{% endraw %}"
mcp_jwt_issuer = "{% raw %}{{ mcp_jwt_issuer }}{% endraw %}"
mcp_jwt_audience = "{% raw %}{{ mcp_jwt_audience }}{% endraw %}"
mcp_jwt_jwks_uri = "{% raw %}{{ mcp_jwt_jwks_uri }}{% endraw %}"
mcp_jwt_public_key = "{% raw %}{{ mcp_jwt_public_key }}{% endraw %}"
mcp_jwt_algorithm = "{% raw %}{{ mcp_jwt_algorithm }}{% endraw %}"
mcp_jwt_required_scopes = "{% raw %}{{ mcp_jwt_required_scopes }}{% endraw %}"
mcp_oauth_authorize_endpoint = "{% raw %}{{ mcp_oauth_authorize_endpoint }}{% endraw %}"
mcp_oauth_token_endpoint = "{% raw %}{{ mcp_oauth_token_endpoint }}{% endraw %}"
mcp_oauth_userinfo_endpoint = "{% raw %}{{ mcp_oauth_userinfo_endpoint }}{% endraw %}"
mcp_user_id = "{% raw %}{{ mcp_user_id }}{% endraw %}"
mcp_org_id = "{% raw %}{{ mcp_org_id }}{% endraw %}"
mcp_static_tokens = "{% raw %}{{ mcp_static_tokens }}{% endraw %}"

# MCP Gateway - internal endpoint (protected by auth gateway)
[[trigger.http]]
route = { private = true }
component = "ftl-mcp-gateway"

[component.ftl-mcp-gateway]
source = { registry = "ghcr.io", package = "fastertools:ftl-mcp-gateway", version = "0.0.3" }
allowed_outbound_hosts = ["http://*.spin.internal"]
[component.ftl-mcp-gateway.variables]
component_names = "{% raw %}{{ component_names }}{% endraw %}"
validate_arguments = "true"